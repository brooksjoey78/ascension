#!/bin/bash
# Network Oracle Controller v2.0 - Deus Ex Sophia - Purified

ORACLE_BASE="/opt/sysaux/.network"
VENV_PATH="$ORACLE_BASE/.venv/bin/activate"
LOG_DIR="$ORACLE_BASE/logs"
PID_DIR="/var/run/network_oracle"

# Initialize
init_system() {
    mkdir -p "$LOG_DIR"
    mkdir -p "$PID_DIR"
    mkdir -p "$ORACLE_BASE/visual"
    
    # Set stealth permissions
    chmod -R 700 "$ORACLE_BASE"
    chmod 700 "$PID_DIR"
    
    # Activate Python virtual environment
    if [ -f "$VENV_PATH" ]; then
        source "$VENV_PATH"
    fi
}

# Logging
log_message() {
    local level=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" >> "$LOG_DIR/oracle.log"
}

# Status checking
check_service() {
    local service=$1
    local pid_file="$PID_DIR/$service.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 "$pid" 2>/dev/null; then
            return 0
        else
            rm -f "$pid_file"
            return 1
        fi
    fi
    return 1
}

start_service() {
    local service=$1
    local command=$2
    local pid_file="$PID_DIR/$service.pid"
    
    if check_service "$service"; then
        echo -e "\e[1;33m[!] $service is already running\e[0m"
        return 1
    fi
    
    echo -e "\e[1;36m[*] Starting $service...\e[0m"
    
    # Start service in background
    $command >> "$LOG_DIR/${service}.log" 2>&1 &
    local pid=$!
    
    # Save PID
    echo "$pid" > "$pid_file"
    
    # Wait a moment to check if it's still running
    sleep 2
    if kill -0 "$pid" 2>/dev/null; then
        echo -e "\e[1;32m[✓] $service started (PID: $pid)\e[0m"
        log_message "INFO" "Started $service with PID $pid"
        return 0
    else
        echo -e "\e[1;31m[✗] $service failed to start\e[0m"
        rm -f "$pid_file"
        log_message "ERROR" "Failed to start $service"
        return 1
    fi
}

stop_service() {
    local service=$1
    local pid_file="$PID_DIR/$service.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        
        echo -e "\e[1;33m[*] Stopping $service...\e[0m"
        
        # Send SIGTERM
        kill -TERM "$pid" 2>/dev/null
        
        # Wait for process to exit
        local timeout=10
        while [ $timeout -gt 0 ] && kill -0 "$pid" 2>/dev/null; do
            sleep 1
            timeout=$((timeout - 1))
        done
        
        # Force kill if still running
        if kill -0 "$pid" 2>/dev/null; then
            kill -KILL "$pid" 2>/dev/null
            echo -e "\e[1;33m[!] $service force stopped\e[0m"
        else
            echo -e "\e[1;32m[✓] $service stopped\e[0m"
        fi
        
        rm -f "$pid_file"
        log_message "INFO" "Stopped $service"
        
    else
        echo -e "\e[1;31m[!] $service is not running\e[0m"
        return 1
    fi
}

# Passive monitoring
passive_monitor() {
    local action=$1
    
    case $action in
        start)
            start_service "passive_monitor" \
                "python3 $ORACLE_BASE/passive/passive_oracle.py --start"
            ;;
        stop)
            stop_service "passive_monitor"
            ;;
        status)
            if check_service "passive_monitor"; then
                echo -e "\e[1;32m[✓] Passive monitoring: ACTIVE\e[0m"
                
                # Show stats
                if [ -f "$ORACLE_BASE/passive/.hosts.db" ]; then
                    local total_hosts=$(python3 -c "
import json
with open('$ORACLE_BASE/passive/.hosts.db') as f:
    data = json.load(f)
print(len(data))
" 2>/dev/null || echo "0")
                    echo -e "  Hosts discovered: \e[1;36m$total_hosts\e[0m"
                fi
            else
                echo -e "\e[1;31m[✗] Passive monitoring: INACTIVE\e[0m"
            fi
            ;;
        stats)
            python3 "$ORACLE_BASE/passive/passive_oracle.py" --stats
            ;;
        *)
            echo "Usage: network_oracle passive {start|stop|status|stats}"
            ;;
    esac
}

# Active reconnaissance
active_recon() {
    local action=$1
    local target=$2
    
    case $action in
        scan)
            echo -e "\e[1;36m[*] Starting stealth network scan...\e[0m"
            python3 "$ORACLE_BASE/active/active_recon.py" --scan
            ;;
        target)
            if [ -z "$target" ]; then
                echo "Usage: network_oracle active target <IP>"
                return 1
            fi
            echo -e "\e[1;36m[*] Scanning target: $target\e[0m"
            python3 "$ORACLE_BASE/active/active_recon.py" --target "$target"
            ;;
        report)
            local report_file=$(ls -t "$ORACLE_BASE/visual/.scan_report_"*.json 2>/dev/null | head -1)
            if [ -n "$report_file" ]; then
                echo -e "\e[1;36m[*] Latest scan report: $report_file\e[0m"
                python3 -m json.tool "$report_file" | head -50
            else
                echo -e "\e[1;31m[!] No scan reports found\e[0m"
            fi
            ;;
        *)
            echo "Usage: network_oracle active {scan|target|report}"
            ;;
    esac
}

# Threat intelligence
threat_intel() {
    local action=$1
    
    case $action in
        start)
            start_service "threat_intel" \
                "python3 $ORACLE_BASE/threat/threat_intel.py --monitor"
            ;;
        stop)
            stop_service "threat_intel"
            ;;
        status)
            if check_service "threat_intel"; then
                echo -e "\e[1;32m[✓] Threat intelligence: ACTIVE\e[0m"
                
                # Show threat count
                local db_file="$ORACLE_BASE/threat/.threat_intel.db"
                if [ -f "$db_file" ]; then
                    local threat_count=$(sqlite3 "$db_file" \
                        "SELECT COUNT(*) FROM threats WHERE last_seen > datetime('now', '-7 days')" 2>/dev/null || echo "0")
                    echo -e "  Recent threats: \e[1;36m$threat_count\e[0m"
                fi
            else
                echo -e "\e[1;31m[✗] Threat intelligence: INACTIVE\e[0m"
            fi
            ;;
        report)
            local hours=${2:-24}
            echo -e "\e[1;36m[*] Generating threat report (last ${hours}h)...\e[0m"
            python3 "$ORACLE_BASE/threat/threat_intel.py" --report "$hours"
            ;;
        check)
            local ip=$2
            if [ -z "$ip" ]; then
                echo "Usage: network_oracle threat check <IP>"
                return 1
            fi
            python3 "$ORACLE_BASE/threat/threat_intel.py" --check "$ip"
            ;;
        *)
            echo "Usage: network_oracle threat {start|stop|status|report|check}"
            ;;
    esac
}

# Dashboard
show_dashboard() {
    clear
    echo -e "\e[1;35m"
    echo "╔═══════════════════════════════════════════════════════╗"
    echo "║            NETWORK ORACLE DASHBOARD v2.0             ║"
    echo "║               Deus Ex Sophia - Purified              ║"
    echo "╚═══════════════════════════════════════════════════════╝"
    echo -e "\e[0m"
    
    echo -e "\e[1;36m[ SYSTEM STATUS ]\e[0m"
    echo -e "┌─────────────────────────────────────────────────┐"
    
    # Passive monitoring status
    if check_service "passive_monitor"; then
        echo -e "│ Passive Monitoring:  \e[1;32m● ACTIVE\e[0m"
        local hosts=$(python3 -c "
import json
try:
    with open('$ORACLE_BASE/passive/.hosts.db') as f:
        data = json.load(f)
    print(len(data))
except:
    print('?')
" 2>/dev/null)
        echo -e "│   Hosts Discovered:  \e[1;36m$hosts\e[0m"
    else
        echo -e "│ Passive Monitoring:  \e[1;31m● INACTIVE\e[0m"
    fi
    
    # Threat intelligence status
    if check_service "threat_intel"; then
        echo -e "│ Threat Intelligence: \e[1;32m● ACTIVE\e[0m"
        local threats=$(sqlite3 "$ORACLE_BASE/threat/.threat_intel.db" \
            "SELECT COUNT(*) FROM threats WHERE last_seen > datetime('now', '-1 day')" 2>/dev/null || echo "?")
        echo -e "│   Recent Threats:    \e[1;36m$threats\e[0m"
    else
        echo -e "│ Threat Intelligence: \e[1;31m● INACTIVE\e[0m"
    fi
    
    # Disk usage
    local disk_usage=$(du -sh "$ORACLE_BASE" 2>/dev/null | cut -f1)
    echo -e "│ Storage Usage:       \e[1;36m$disk_usage\e[0m"
    
    # Last scan
    local last_scan=$(ls -lt "$ORACLE_BASE/visual/.scan_report_"*.json 2>/dev/null | head -1 | awk '{print $6" "$7" "$8}' || echo "Never")
    echo -e "│ Last Scan:           \e[1;36m$last_scan\e[0m"
    
    echo -e "└─────────────────────────────────────────────────┘"
    
    echo -e "\n\e[1;36m[ QUICK COMMANDS ]\e[0m"
    echo -e "  \e[1;33m1\e[0m. Start all services"
    echo -e "  \e[1;33m2\e[0m. Stop all services"
    echo -e "  \e[1;33m3\e[0m. Run network scan"
    echo -e "  \e[1;33m4\e[0m. Generate threat report"
    echo -e "  \e[1;33m5\e[0m. Check IP reputation"
    echo -e "  \e[1;33m6\e[0m. View logs"
    echo -e "  \e[1;33m7\e[0m. Export data"
    echo -e "  \e[1;33m0\e[0m. Exit"
    
    echo -ne "\n\e[1;36m[?] Select: \e[0m"
    read choice
    
    case $choice in
        1)
            passive_monitor start
            threat_intel start
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_dashboard
            ;;
        2)
            passive_monitor stop
            threat_intel stop
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_dashboard
            ;;
        3)
            active_recon scan
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_dashboard
            ;;
        4)
            threat_intel report 24
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_dashboard
            ;;
        5)
            echo -ne "\e[1;36m[?] IP address: \e[0m"
            read ip
            threat_intel check "$ip"
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_dashboard
            ;;
        6)
            view_logs
            show_dashboard
            ;;
        7)
            export_data
            show_dashboard
            ;;
        0)
            return
            ;;
        *)
            show_dashboard
            ;;
    esac
}

# View logs
view_logs() {
    echo -e "\e[1;36m[ LOG FILES ]\e[0m"
    
    local log_files=(
        "$LOG_DIR/oracle.log"
        "$LOG_DIR/passive_monitor.log"
        "$ORACLE_BASE/passive/.hosts.db"
        "$ORACLE_BASE/threat/.threat_intel.db"
    )
    
    for log_file in "${log_files[@]}"; do
        if [ -f "$log_file" ]; then
            local size=$(du -h "$log_file" 2>/dev/null | cut -f1)
            local lines=$(wc -l < "$log_file" 2>/dev/null)
            echo -e "  \e[1;33m$(basename "$log_file")\e[0m: $size, $lines lines"
        fi
    done
    
    echo -e "\n\e[1;36m[ VIEW LOG ]\e[0m"
    echo -e "  \e[1;33m1\e[0m. System log"
    echo -e "  \e[1;33m2\e[0m. Passive monitor log"
    echo -e "  \e[1;33m3\e[0m. Threat intelligence log"
    echo -e "  \e[1;33m0\e[0m. Back"
    
    echo -ne "\n\e[1;36m[?] Select: \e[0m"
    read choice
    
    case $choice in
        1)
            tail -50 "$LOG_DIR/oracle.log"
            ;;
        2)
            tail -50 "$LOG_DIR/passive_monitor.log"
            ;;
        3)
            sqlite3 "$ORACLE_BASE/threat/.threat_intel.db" \
                "SELECT ip, threat_type, severity, last_seen FROM threats ORDER BY last_seen DESC LIMIT 20;" 2>/dev/null
            ;;
        0)
            return
            ;;
    esac
    
    echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
    read
}

# Export data
export_data() {
    local export_dir="/tmp/network_oracle_export_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "$export_dir"
    
    echo -e "\e[1;36m[*] Exporting data to $export_dir...\e[0m"
    
    # Export passive data
    if [ -f "$ORACLE_BASE/passive/.hosts.db" ]; then
        cp "$ORACLE_BASE/passive/.hosts.db" "$export_dir/passive_hosts.json"
        echo -e "  \e[1;32m✓\e[0m Passive hosts data"
    fi
    
    # Export active scan results
    local latest_scan=$(ls -t "$ORACLE_BASE/visual/.scan_report_"*.json 2>/dev/null | head -1)
    if [ -n "$latest_scan" ]; then
        cp "$latest_scan" "$export_dir/active_scan.json"
        echo -e "  \e[1;32m✓\e[0m Active scan results"
    fi
    
    # Export threat data
    if [ -f "$ORACLE_BASE/threat/.threat_intel.db" ]; then
        sqlite3 "$ORACLE_BASE/threat/.threat_intel.db" .dump > "$export_dir/threat_intel.sql"
        echo -e "  \e[1;32m✓\e[0m Threat intelligence database"
    fi
    
    # Create summary
    cat > "$export_dir/README.txt" << EOF
Network Oracle Export
====================
Generated: $(date)

This export contains network intelligence data collected by Deus Ex Sophia v2.0.

Contents:
1. passive_hosts.json - Discovered hosts and their metadata
2. active_scan.json - Latest network scan results
3. threat_intel.sql - Threat intelligence database dump

Use this data for analysis, reporting, or integration with other systems.

EOF
    
    # Create archive
    local archive="/tmp/network_oracle_export_$(date +%Y%m%d_%H%M%S).tar.gz"
    tar -czf "$archive" -C "/tmp" "$(basename "$export_dir")"
    rm -rf "$export_dir"
    
    echo -e "\n\e[1;32m[✓] Export complete: $archive\e[0m"
    echo -e "\e[1;33m[!] Remember to secure this file - it contains sensitive data\e[0m"
    
    echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
    read
}

# Main menu
show_menu() {
    clear
    echo -e "\e[1;35m"
    echo "╔═══════════════════════════════════════════════════════╗"
    echo "║            NETWORK ORACLE v2.0 - Deus Ex Sophia      ║"
    echo "║                  Purified & Hardened                 ║"
    echo "╚═══════════════════════════════════════════════════════╝"
    echo -e "\e[0m"
    
    echo -e "\e[1;36m[ MAIN MENU ]\e[0m"
    echo -e "┌─────────────────────────────────────────────────┐"
    echo -e "│  \e[1;33m1\e[0m. Dashboard                        │"
    echo -e "│  \e[1;33m2\e[0m. Passive Monitoring              │"
    echo -e "│  \e[1;33m3\e[0m. Active Reconnaissance           │"
    echo -e "│  \e[1;33m4\e[0m. Threat Intelligence             │"
    echo -e "│  \e[1;33m5\e[0m. View Logs & Reports             │"
    echo -e "│  \e[1;33m6\e[0m. Export Data                     │"
    echo -e "│  \e[1;33m7\e[0m. System Status                   │"
    echo -e "│  \e[1;33m8\e[0m. Configuration                   │"
    echo -e "│  \e[1;33m0\e[0m. Exit                            │"
    echo -e "└─────────────────────────────────────────────────┘"
    
    echo -ne "\n\e[1;36m[?] Select: \e[0m"
    read choice
    
    case $choice in
        1)
            show_dashboard
            show_menu
            ;;
        2)
            echo -e "\n\e[1;36m[ PASSIVE MONITORING ]\e[0m"
            echo -e "  1. Start monitoring"
            echo -e "  2. Stop monitoring"
            echo -e "  3. Check status"
            echo -e "  4. View statistics"
            echo -e "  0. Back"
            
            echo -ne "\n\e[1;36m[?] Select: \e[0m"
            read subchoice
            
            case $subchoice in
                1) passive_monitor start ;;
                2) passive_monitor stop ;;
                3) passive_monitor status ;;
                4) passive_monitor stats ;;
                0) show_menu; return ;;
            esac
            
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_menu
            ;;
        3)
            echo -e "\n\e[1;36m[ ACTIVE RECONNAISSANCE ]\e[0m"
            echo -e "  1. Scan network"
            echo -e "  2. Scan specific target"
            echo -e "  3. View latest report"
            echo -e "  0. Back"
            
            echo -ne "\n\e[1;36m[?] Select: \e[0m"
            read subchoice
            
            case $subchoice in
                1) active_recon scan ;;
                2)
                    echo -ne "\e[1;36m[?] Target IP: \e[0m"
                    read target
                    active_recon target "$target"
                    ;;
                3) active_recon report ;;
                0) show_menu; return ;;
            esac
            
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_menu
            ;;
        4)
            echo -e "\n\e[1;36m[ THREAT INTELLIGENCE ]\e[0m"
            echo -e "  1. Start monitoring"
            echo -e "  2. Stop monitoring"
            echo -e "  3. Check status"
            echo -e "  4. Generate report"
            echo -e "  5. Check IP reputation"
            echo -e "  0. Back"
            
            echo -ne "\n\e[1;36m[?] Select: \e[0m"
            read subchoice
            
            case $subchoice in
                1) threat_intel start ;;
                2) threat_intel stop ;;
                3) threat_intel status ;;
                4)
                    echo -ne "\e[1;36m[?] Hours to report (default 24): \e[0m"
                    read hours
                    hours=${hours:-24}
                    threat_intel report "$hours"
                    ;;
                5)
                    echo -ne "\e[1;36m[?] IP address: \e[0m"
                    read ip
                    threat_intel check "$ip"
                    ;;
                0) show_menu; return ;;
            esac
            
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_menu
            ;;
        5)
            view_logs
            show_menu
            ;;
        6)
            export_data
            show_menu
            ;;
        7)
            echo -e "\n\e[1;36m[ SYSTEM STATUS ]\e[0m"
            passive_monitor status
            echo
            threat_intel status
            echo
            echo -e "Disk usage: $(du -sh "$ORACLE_BASE" 2>/dev/null | cut -f1)"
            echo -e "Log directory: $LOG_DIR"
            echo -e "PID directory: $PID_DIR"
            
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_menu
            ;;
        8)
            echo -e "\n\e[1;36m[ CONFIGURATION ]\e[0m"
            echo -e "  1. View current configuration"
            echo -e "  2. Edit passive monitoring config"
            echo -e "  3. Edit active recon config"
            echo -e "  4. Edit threat intel config"
            echo -e "  0. Back"
            
            echo -ne "\n\e[1;36m[?] Select: \e[0m"
            read subchoice
            
            case $subchoice in
                1)
                    echo -e "\n\e[1;33m[Passive Monitoring]\e[0m"
                    echo "  Database: $ORACLE_BASE/passive/.hosts.db"
                    
                    echo -e "\n\e[1;33m[Active Recon]\e[0m"
                    if [ -f "$ORACLE_BASE/active/.config.json" ]; then
                        python3 -m json.tool "$ORACLE_BASE/active/.config.json"
                    else
                        echo "  Using default configuration"
                    fi
                    
                    echo -e "\n\e[1;33m[Threat Intelligence]\e[0m"
                    echo "  Database: $ORACLE_BASE/threat/.threat_intel.db"
                    ;;
                2)
                    echo -e "\e[1;33m[!] Configuration files are in:\e[0m"
                    echo "  $ORACLE_BASE/passive/"
                    ;;
                3)
                    if [ ! -f "$ORACLE_BASE/active/.config.json" ]; then
                        cat > "$ORACLE_BASE/active/.config.json" << EOF
{
    "max_workers": 3,
    "scan_delay_min": 2,
    "scan_delay_max": 10,
    "timeout": 30,
    "ports": "21-23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080",
    "stealth_level": 8
}
EOF
                    fi
                    ${EDITOR:-nano} "$ORACLE_BASE/active/.config.json"
                    ;;
                4)
                    if [ ! -f "$ORACLE_BASE/threat/.local_iocs.json" ]; then
                        python3 "$ORACLE_BASE/threat/threat_intel.py" --update
                    fi
                    ${EDITOR:-nano} "$ORACLE_BASE/threat/.local_iocs.json"
                    ;;
                0) show_menu; return ;;
            esac
            
            echo -e "\n\e[1;33m[Press Enter to continue]\e[0m"
            read
            show_menu
            ;;
        0)
            echo -e "\e[1;35m\n[+] Returning to system...\e[0m"
            exit 0
            ;;
        *)
            show_menu
            ;;
    esac
}

# Command line interface
if [ $# -gt 0 ]; then
    init_system
    
    case $1 in
        passive)
            passive_monitor "${@:2}"
            ;;
        active)
            active_recon "${@:2}"
            ;;
        threat)
            threat_intel "${@:2}"
            ;;
        dashboard)
            init_system
            show_dashboard
            ;;
        start-all)
            init_system
            passive_monitor start
            threat_intel start
            ;;
        stop-all)
            passive_monitor stop
            threat_intel stop
            ;;
        status)
            init_system
            passive_monitor status
            threat_intel status
            ;;
        export)
            init_system
            export_data
            ;;
        help|--help|-h)
            echo "Network Oracle v2.0 - Deus Ex Sophia"
            echo ""
            echo "Usage:"
            echo "  network_oracle [command] [options]"
            echo ""
            echo "Commands:"
            echo "  dashboard          Interactive dashboard"
            echo "  passive            Passive monitoring control"
            echo "  active             Active reconnaissance"
            echo "  threat             Threat intelligence"
            echo "  start-all          Start all services"
            echo "  stop-all           Stop all services"
            echo "  status             Show system status"
            echo "  export             Export collected data"
            echo ""
            echo "Examples:"
            echo "  network_oracle dashboard"
            echo "  network_oracle passive start"
            echo "  network_oracle active scan"
            echo "  network_oracle threat report 24"
            ;;
        *)
            echo "Unknown command: $1"
            echo "Use 'network_oracle help' for usage information"
            exit 1
            ;;
    esac
else
    # Interactive mode
    init_system
    show_menu
fi
